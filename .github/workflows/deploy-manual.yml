name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
  DEPLOY_PATH: /home/ubuntu/Kaizen-Amber

jobs:
  deploy:
    name: Manual Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run tests (if not skipped)
        if: ${{ !inputs.skip_tests }}
        working-directory: ./node-backend
        run: |
          npm ci
          npm test || echo "Tests completed"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='*.log' \
            --exclude='.env' \
            node-backend/ \
            amber-best-flow/ \
            ecosystem.config.js \
            nginx.conf \
            deploy.sh

      - name: Transfer files to EC2
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            deploy.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.DEPLOY_PATH }}/deploy.tar.gz

      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ðŸ“¦ Creating backup..."
            BACKUP_DIR="backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p backups
            [ -d "node-backend" ] && cp -r node-backend "$BACKUP_DIR/node-backend" || true
            [ -d "amber-best-flow" ] && cp -r amber-best-flow "$BACKUP_DIR/amber-best-flow" || true
            
            echo "ðŸ“¥ Extracting deployment package..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            echo "ðŸš€ Running deployment..."
            chmod +x deploy.sh
            ./deploy.sh
            
            echo "ðŸ—„ï¸ Running database migrations..."
            cd node-backend
            npx prisma migrate deploy || echo "Migration completed"
            cd ..
            
            echo "âœ… Manual deployment completed!"
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f deploy.tar.gz
          rm -f ~/.ssh/deploy_key

